<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="3D Implicit Function Viewer" />

  <title>ImpVis - 3D Implicit Function Viewer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Roboto+Mono&display=swap" rel="stylesheet" />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <script>
    const mathJaxReady = new Promise(resolve => {
      window.MathJax = {
        chtml: { displayAlign: 'left' },
        startup: {
          typeset: false,
          ready() {
            MathJax.startup.defaultReady();
            resolve();
          }
        }
      };
    });
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <style>
    :root {
      --bg-color: #3c5f8d;
      --text-color: #ffffff;
      --font-sans: 'Roboto', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    h1,
    h2,
    h3 {
      text-shadow: 1px 1px 1px black;
    }

    .loader-container {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      background-color: var(--bg-color);
      transition: opacity 0.5s ease-out;
    }

    .loader-container.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .circular-loader {
      width: 60px;
      height: 60px;
      position: relative;
      margin-bottom: 20px;
    }

    .circular-loader svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .circular-loader-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 8;
    }

    .circular-loader-progress {
      fill: none;
      stroke: var(--text-color);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.3s ease;
    }

    .circular-loader.spinning .circular-loader-progress {
      animation: spin-stroke 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes spin-stroke {
      0% {
        stroke-dashoffset: 220;
      }

      50% {
        stroke-dashoffset: 55;
      }

      100% {
        stroke-dashoffset: 220;
      }
    }

    .loader-status {
      font-size: 1.2em;
      text-align: center;
      min-height: 1.5em;
    }

    .status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      z-index: 10;
    }

    #canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      will-change: transform;
      touch-action: none;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      background: transparent;
    }

    #eqnname {
      position: absolute;
      top: 0;
      left: 1em;
      margin-top: 0.8em;
      pointer-events: none;
      z-index: 5;
    }

    #equation {
      position: absolute;
      top: 0.2em;
      left: 0;
      margin: 3em 1em 0 16px;
      width: calc(100% - 2em);
      pointer-events: none;
      overflow: hidden;
      z-index: 5;
    }

    #equation mjx-math {
      font-weight: 600;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    #output {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 0 1em;
      font-family: var(--font-mono);
      font-stretch: condensed;
      font-size: small;
      background-color: rgba(0, 0, 0, 0.9);
      color: inherit;
      border: none;
      resize: none;
      pointer-events: none;
      z-index: 5;
      display: none;
    }
  </style>
</head>

<body>
  <div class="loader-container" id="loaderContainer">
    <div class="circular-loader" id="circularLoader">
      <svg viewBox="0 0 80 80">
        <circle class="circular-loader-bg" cx="40" cy="40" r="36"></circle>
        <circle class="circular-loader-progress" id="loaderProgress" cx="40" cy="40" r="36"></circle>
      </svg>
    </div>
    <div class="loader-status" id="loaderStatus">Loading...</div>
  </div>

  <div class="status" id="status" style="display:none;"></div>

  <div id="container" oncontextmenu="event.preventDefault()">
    <canvas id="canvas"></canvas>
    <div id="eqnname" hidden>
      <h1></h1>
    </div>
    <div id="equation" hidden>
      <h3></h3>
    </div>
  </div>

  <output id="output"></output>

  <script>
    function isMobile() {
      return /Mobi|Android/i.test(navigator.userAgent);
    }

    function isInIframe() {
      try { return window.self !== window.top; } catch { return true; }
    }

    const getElement = id => {
      const el = document.getElementById(id);
      if (!el) console.warn(`Missing element: #${id}`);
      return el;
    };

    const elements = {
      loaderContainer: getElement('loaderContainer'),
      loaderStatus: getElement('loaderStatus'),
      circularLoader: getElement('circularLoader'),
      loaderProgress: getElement('loaderProgress'),
      status: getElement('status'),
      container: getElement('container'),
      canvas: getElement('canvas'),
      eqnName: getElement('eqnname'),
      equation: getElement('equation'),
      output: getElement('output')
    };

    const {
      container,
      equation,
      eqnName,
      loaderContainer,
      loaderStatus,
      circularLoader,
      loaderProgress
    } = elements;

    if (isInIframe()) {
      document.body.style.backgroundColor = 'transparent';
      if (loaderContainer) loaderContainer.style.display = 'none';
    }

    const urlParams = new URLSearchParams(window.location.search);
    const initialFunctionName = (urlParams.get('function') || '').replace(/\/$/, '');

    const normalizedKeys = new Set(
      [...urlParams.keys()].map(k => k.replace(/\/$/, ''))
    );

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        const req =
          container.requestFullscreen ??
          container.webkitRequestFullscreen ??
          container.mozRequestFullScreen ??
          container.msRequestFullscreen;
        req?.call(container);
      } else {
        document.exitFullscreen?.();
      }
    }

    const CONFIG = {
      breakpoint: 990,
      baseFontSize: 18,
      baseTopOffset: 25,
      marginTop: 17,
    };

    function resizeEquation() {
      const node = equation;
      if (!node) return;

      const w = document.body.clientWidth;
      let size = CONFIG.baseFontSize;
      let topOffset = CONFIG.baseTopOffset;

      if (w < CONFIG.breakpoint) {
        const scale = Math.pow(w / CONFIG.breakpoint, 1.85);
        size = CONFIG.baseFontSize * scale;
        topOffset = CONFIG.baseTopOffset * CONFIG.breakpoint / w;
      }

      node.style.fontSize = `${size}px`;
      node.style.marginTop = `${CONFIG.marginTop + topOffset}px`;
    }

    window.addEventListener('resize', resizeEquation, { passive: true });

    const updateEquation = (() => {
      let pending = null;

      return async function (eq, comment) {
        const heading = equation?.querySelector('h3');
        if (!heading) return;

        if (pending) clearTimeout(pending);

        pending = setTimeout(async () => {
          pending = null;

          const isEmptyComment = !comment.trim();
          const sep = isEmptyComment ? '' : ',';

          heading.textContent =
            `\\[
              \\begin{align*}
                &${eq}${sep} \\\\[1.25ex]
                &${comment}
              \\end{align*}
             \\]`;

          await mathJaxReady;
          await MathJax.typesetPromise([heading]);

          resizeEquation();
        }, 20);
      };
    })();

    function updateEquationName(name) {
      const heading = eqnName?.querySelector('h1');
      if (heading) heading.textContent = name;
      eqnName.hidden = !name;
    }

    let visDebounce = null;

    function setVisible(v) {
      clearTimeout(visDebounce);
      visDebounce = setTimeout(() => {
        // Module may not exist yet; ensure we don't throw
        if (typeof Module !== 'undefined') Module.documentVisible = !!v;
      }, 50);
    }

    function evaluateVisibility() {
      const visible =
        document.visibilityState === 'visible' &&
        document.hasFocus();
      setVisible(visible);
    }

    ['visibilitychange', 'focus', 'blur', 'pageshow', 'pagehide']
      .forEach(ev => window.addEventListener(ev, evaluateVisibility, false));

    function hideLoader() {
      if (!loaderContainer) return;

      loaderContainer.addEventListener('transitionend', () => {
        loaderContainer.style.display = 'none';
      }, { once: true });

      loaderContainer.classList.add('fade-out');

      if (loaderStatus) loaderStatus.style.visibility = 'hidden';
    }

    // Emscripten Module
    var Module = window.Module || (window.Module = {});

    Module.canvas = elements.canvas;

    Module.documentVisible = Module.documentVisible ?? true;

    Module.onRuntimeInitialized = Module.onRuntimeInitialized || function () {
      if (normalizedKeys.has('no_axes')) Module.hideAxes();
      if (normalizedKeys.has('no_bkgnd')) Module.hideBackground();
      if (normalizedKeys.has('no_ui')) Module.hideUI();
      if (normalizedKeys.has('no_mathjax')) Module.hideEquation();

      if (typeof Module.setInitialFunction === 'function') {
        Module.setInitialFunction(initialFunctionName);
      }
      hideLoader();

      document.body.style.backgroundColor =
        isInIframe() ? 'transparent' : 'black';
    };

    Module.print = Module.print || (function () {
      const out = elements.output;
      if (out) out.value = '';
      return function (...args) {
        const text = args.join(' ');
        console.log(text);
        if (out && out.style.display !== 'none') {
          out.value += text + '\n';
          out.scrollTop = out.scrollHeight;
        }
      };
    })();

    Module.printErr = Module.printErr || console.error;

    Module.setStatus = Module.setStatus || (function () {
      let last = { time: 0, text: '' };
      const progressRe = /([^(]+)\((\d+(?:\.\d+)?)\/(\d+)\)/;

      return function (text) {
        const now = Date.now();
        const match = text.match(progressRe);

        if (match && text === last.text && now - last.time < 30) return;
        last = { time: now, text };

        const eq = elements.equation;
        const name = elements.eqnName;

        if (text.includes('Starting')) {
          if (circularLoader) circularLoader.style.display = 'none';
          if (loaderStatus) loaderStatus.textContent = text;
          if (eq) eq.hidden = true;
          if (name) name.hidden = true;
        } else if (match) {
          const label = match[1].trim();
          const current = parseFloat(match[2]);
          const total = parseFloat(match[3]);
          const pct = total > 0 ? Math.min(100, Math.max(0, (current / total) * 100)) : 0;

          if (circularLoader) {
            circularLoader.style.display = 'block';
            circularLoader.classList.remove('spinning');
          }

          if (loaderProgress) {
            const r = parseFloat(loaderProgress.getAttribute("r"));
            const circ = 2 * Math.PI * r;
            loaderProgress.style.strokeDasharray = circ;
            loaderProgress.style.strokeDashoffset = circ * (1 - pct / 100);
          }

          if (loaderStatus) loaderStatus.textContent = label;

          if (eq) eq.hidden = true;
          if (name) name.hidden = true;
        } else {
          if (circularLoader) circularLoader.style.display = 'block';
          if (loaderStatus) loaderStatus.textContent = text;

          if (eq) eq.hidden = false;
          if (name) name.hidden = false;
        }
      };
    })();

    // Initial status and spinner
    Module.setStatus('Starting...');
    if (circularLoader) circularLoader.classList.add('spinning');

    window.onerror = () => {
      Module.setStatus('Exception thrown, see console');
      Module.setStatus = text => {
        if (text) Module.printErr('[post-exception status] ' + text);
      };
    };

    // Expose helper functions called from C++
    window.updateEquation = updateEquation;
    window.updateEquationName = updateEquationName;
    window.toggleFullscreen = toggleFullscreen;
    window.setMathJaxVisibility = function (visible) {
      if (equation) equation.hidden = !visible;
      if (eqnName) eqnName.hidden = !visible;
    };
  </script>

  <script defer src="impvis.js"></script>
</body>

</html>