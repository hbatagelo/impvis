/**
 * @file abcgOpenGLImage.cpp
 * @brief Definition of OpenGL texture loading helper functions.
 *
 * This file is part of ABCg (https://github.com/hbatagelo/abcg).
 *
 * @copyright (c) 2021--2026 Harlen Batagelo. All rights reserved.
 * This project is released under the MIT License.
 */

#include "abcgOpenGLImage.hpp"

#include <cppitertools/itertools.hpp>
#include <fmt/format.h>
#include <gsl/gsl>

#include "abcgImage.hpp"

namespace abcg {

/**
 * @brief Creates an OpenGL 2D texture from an image loaded from a filesystem
 * path.
 *
 * @param createInfo Texture creation settings.
 *
 * @throw abcg::RuntimeError If the image cannot be loaded.
 *
 * @return ID of the texture, as generated by glGenTextures.
 */
GLuint loadOpenGLTexture(OpenGLTextureCreateInfo const &createInfo) {
  abcg::Image image{createInfo.path};
  auto const &[width, height, channels]{image.dimensions()};

  GLenum internalFormat{};
  GLenum format{};

  if (channels == 3) {
    internalFormat = createInfo.sRGBToLinear ? GL_SRGB8 : GL_RGB;
    format = GL_RGB;
  } else {
    internalFormat = createInfo.sRGBToLinear ? GL_SRGB8_ALPHA8 : GL_RGBA;
    format = GL_RGBA;
  }

  if (createInfo.flipUpsideDown) {
    image.flipVertically();
  }

  GLuint textureID{};
  glGenTextures(1, &textureID);
  glBindTexture(GL_TEXTURE_2D, textureID);
  glTexImage2D(GL_TEXTURE_2D, 0, gsl::narrow<GLint>(internalFormat),
               gsl::narrow<GLsizei>(width), gsl::narrow<GLsizei>(height), 0,
               format, GL_UNSIGNED_BYTE, image.data().data());

  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);

  if (createInfo.generateMipmaps) {
    glGenerateMipmap(GL_TEXTURE_2D);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER,
                    GL_LINEAR_MIPMAP_LINEAR);
  }

  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);
  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);

  glBindTexture(GL_TEXTURE_2D, 0);
  return textureID;
}

/**
 * @brief Creates an OpenGL cubemap texture from a set of images loaded from
 * filesystem paths.
 *
 * @param createInfo Texture creation settings.
 *
 * @throw abcg::RuntimeError If any cubemap face image cannot be loaded.
 *
 * @return ID of the cubemap texture, as generated by glGenTextures.
 */
GLuint loadOpenGLCubemap(OpenGLCubemapCreateInfo const &createInfo) {
  GLuint textureID{};
  glGenTextures(1, &textureID);
  glBindTexture(GL_TEXTURE_CUBE_MAP, textureID);

  for (auto &&[index, path] : iter::enumerate(createInfo.paths)) {
    abcg::Image image{path, abcg::Image::ChannelLayout::RGB};
    auto const &[width, height, channels]{image.dimensions()};

    auto target{GL_TEXTURE_CUBE_MAP_POSITIVE_X + gsl::narrow<GLenum>(index)};

    if (createInfo.rightHandedSystem) {
      if (target == GL_TEXTURE_CUBE_MAP_POSITIVE_Y ||
          target == GL_TEXTURE_CUBE_MAP_NEGATIVE_Y) {
        image.flipVertically();
      } else {
        image.flipHorizontally();
      }

      if (target == GL_TEXTURE_CUBE_MAP_POSITIVE_Z) {
        target = GL_TEXTURE_CUBE_MAP_NEGATIVE_Z;
      } else if (target == GL_TEXTURE_CUBE_MAP_NEGATIVE_Z) {
        target = GL_TEXTURE_CUBE_MAP_POSITIVE_Z;
      }
    }

    glTexImage2D(target, 0, GL_RGB, gsl::narrow<GLsizei>(width),
                 gsl::narrow<GLsizei>(height), 0, GL_RGB, GL_UNSIGNED_BYTE,
                 image.data().data());
  }

  glTexParameteri(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
  glTexParameteri(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
  glTexParameteri(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_WRAP_R, GL_CLAMP_TO_EDGE);

  glTexParameteri(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
  glTexParameteri(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_MIN_FILTER, GL_LINEAR);

  if (createInfo.generateMipmaps) {
    glGenerateMipmap(GL_TEXTURE_CUBE_MAP);
    glTexParameteri(GL_TEXTURE_CUBE_MAP, GL_TEXTURE_MIN_FILTER,
                    GL_LINEAR_MIPMAP_LINEAR);
  }

  return textureID;
}

} // namespace abcg
